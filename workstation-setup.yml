---
- hosts: localhost

  tasks:

    # - name: Install VirtualBox Keys from Oracle
    #   apt_key:
    #     url: "{{ item }}"
    #     state: present
    #   with_items:
    #     - https://www.virtualbox.org/download/oracle_vbox_2016.asc
    #     - https://www.virtualbox.org/download/oracle_vbox.asc
    #   become: yes

    # - name: Add VirtualBox repo
    #   apt_repository:
    #     repo: deb https://download.virtualbox.org/virtualbox/debian bionic partner
    #     state: present
    #   become: yes

    - name: Only run "update_cache=yes" if the last one is more than 1 hour ago
      apt:
        update_cache: yes
        cache_valid_time: 3600
      become: yes

    # # https://www.linuxbabe.com/ubuntu/install-nvidia-driver-ubuntu-18-04
    # - name: Install Graphics Drivers PPA repo
    #   apt_repository:
    #       repo: ppa:graphics-drivers/ppa
    #       state: present
    #   become: yes

    - name : Install packages
      apt:
        name: "{{ packages }}"
      vars:
        packages:
          - cpanminus
          - curl
          - gimp
          - gnome-tweaks
          - htop
          - jq
          - libappindicator-dev   # http://tipsonubuntu.com/2018/05/25/re-enable-shutter-app-icon-ubuntu-18-04-system-tray/
          - mysql-client
          - net-tools
          - nmap
          # - nvidia-driver-396
          - openvpn-systemd-resolved
          - pwgen
          - python-pip
          - python3-pip
          - shutter
          - terminator
          - transmission
          # - virtualbox-5.2
      become: yes

    - name: Install Gtk2::AppIndicator
      cpanm:
        name: Gtk2::AppIndicator  # http://tipsonubuntu.com/2018/05/25/re-enable-shutter-app-icon-ubuntu-18-04-system-tray/
      become: yes

    - name: Check if Zoom is installed
      shell: dpkg-query -W 'zoom'
      ignore_errors: True
      changed_when: false
      register: is_zoom

    - name : Install Zoom
      apt:
        deb: https://zoom.us/client/latest/zoom_amd64.deb
      become: yes
      when: is_zoom is failed

    - name: Check if Visual Studio Code is installed
      shell: dpkg-query -W 'code'
      ignore_errors: True
      changed_when: false
      register: is_code

    - name : Install Visual Studio Code
      apt:
        deb: https://go.microsoft.com/fwlink/?LinkID=760868
      become: yes
      when: is_code is failed

    - name: Check if Discord is installed
      shell: dpkg-query -W 'discord'
      ignore_errors: True
      changed_when: false
      register: is_discord 

    - name : Install Discord
      apt:
        deb: https://discordapp.com/api/download?platform=linux&format=deb
      become: yes
      when: is_discord is failed

    - name: Check if Slack is installed
      shell: dpkg-query -W 'slack-desktop'
      ignore_errors: True
      changed_when: false
      register: is_slack

    - name : Install Slack
      apt:
        deb: https://downloads.slack-edge.com/linux_releases/slack-desktop-3.1.0-amd64.deb
      become: yes
      when: is_slack is failed

    - name: Check if Dropbox is installed
      shell: dpkg-query -W 'dropbox'
      ignore_errors: True
      changed_when: false
      register: is_dropbox

    - name : Install Dropbox
      apt:
        deb: https://www.dropbox.com/download?dl=packages/ubuntu/dropbox_2015.10.28_amd64.deb
      become: yes
      when: is_dropbox is failed

    - name: Remove useless packages from the cache
      apt:
        autoclean: yes
      become: yes

    - name: Remove dependencies that are no longer required
      apt:
        autoremove: yes
      become: yes

    # Set of symlinks required for VMWare Horizon Client
    - file:
        src: /usr/lib/x86_64-linux-gnu/libgstreamer-1.0.so.0
        dest: /usr/lib/x86_64-linux-gnu/libgstreamer-0.10.so.0
        owner: root
        group: root
        state: link
      become: yes

    - file:
        src: /usr/lib/x86_64-linux-gnu/libgstapp-1.0.so.0
        dest: /usr/lib/x86_64-linux-gnu/libgstapp-0.10.so.0
        owner: root
        group: root
        state: link
      become: yes

    - file:
        src: /usr/lib/x86_64-linux-gnu/libgstbase-1.0.so.0
        dest: /usr/lib/x86_64-linux-gnu/libgstbase-0.10.so.0
        owner: root
        group: root
        state: link
      become: yes

    - lineinfile:
        path: ~/.config/terminator/config 
        regexp: '.*size =.*'
        insertafter: '.*type = Window'
        line: '      size = 2000, 1000'
        create: no
        
    - name: Install pip packages
      pip:
        name: "{{ packages }}"
      vars:
        packages:
          - boardgamegeek2 # purely for my own enjoyment
          - mdv # View Markdown Files in Terminal
      become: yes

    # - name: Add an Apt signing key, uses whichever key is at the URL
    #   apt_key:
    #     url: "{{ item }}"
    #     state: present
    #   with_items:
    #     - https://www.virtualbox.org/download/oracle_vbox_2016.asc
    #     - https://www.virtualbox.org/download/oracle_vbox.asc

    # Set fs.inotify.max_user_watches required for larger VS code workspaces
    # Default: 8192
    # https://code.visualstudio.com/docs/setup/linux#_visual-studio-code-is-unable-to-watch-for-file-changes-in-this-large-workspace-error-enospc
    - name: Set fs.inotify.max_user_watches
      sysctl:
        name: fs.inotify.max_user_watches
        value: 524288
        sysctl_set: yes
        state: present
        reload: yes
      become: yes
