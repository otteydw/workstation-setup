---
- hosts: localhost

  tasks:

    # - name: Install VirtualBox Keys from Oracle
    #   apt_key:
    #     url: "{{ item }}"
    #     state: present
    #   with_items:
    #     - https://www.virtualbox.org/download/oracle_vbox_2016.asc
    #     - https://www.virtualbox.org/download/oracle_vbox.asc
    #   become: yes

    # - name: Add VirtualBox repo
    #   apt_repository:
    #     repo: deb https://download.virtualbox.org/virtualbox/debian bionic partner
    #     state: present
    #   become: yes

    - name: Update the apt cache if the last update was more than 1 hour ago
      apt:
        update_cache: yes
        cache_valid_time: 3600
      become: yes

    # # https://www.linuxbabe.com/ubuntu/install-nvidia-driver-ubuntu-18-04
    # - name: Install Graphics Drivers PPA repo
    #   apt_repository:
    #       repo: ppa:graphics-drivers/ppa
    #       state: present
    #   become: yes

    - name : Install packages
      apt:
        name:
          - boxes
          - clamav
          - cpanminus
          - curl
          - dirmngr # AZ cli
          - figlet
          - flameshot
          - gimp
          - gnome-tweaks
          - htop
          - jq
          - libappindicator-dev   # http://tipsonubuntu.com/2018/05/25/re-enable-shutter-app-icon-ubuntu-18-04-system-tray/
          - lsb-release # AZ cli
          - mutt
          - mysql-client
          - net-tools
          - nmap
          # - nvidia-driver-396
          - openvpn-systemd-resolved
          - pwgen
          - python-pip
          - python3-pip
          - speedtest-cli
          - terminator
          - transmission
          # - virtualbox-5.2
          - whois
          # The following packages added for Docker CE (https://docs.docker.com/install/linux/docker-ce/ubuntu/)
          - apt-transport-https  # Also for az cli
          - ca-certificates
          - gnupg-agent
          - software-properties-common  # Also for az cli
          # End Docker CE Package List
          # https://boomi.slack.com/archives/G0UUG0PFS/p1550855956035300
          # sudo apt-get install --install-recommends linux-generic-hwe-18.04 xserver-xorg-hwe-18.04
          - linux-generic-hwe-18.04
          - xserver-xorg-hwe-18.04
          # End
      become: yes

    # Replaced shutter with flameshot, so this may no longer be necessary.  But I don't know....
    - name: Install Gtk2::AppIndicator
      cpanm:
        name: Gtk2::AppIndicator  # http://tipsonubuntu.com/2018/05/25/re-enable-shutter-app-icon-ubuntu-18-04-system-tray/
      become: yes

    - name: Check if Zoom is installed
      shell: dpkg-query -W 'zoom'
      ignore_errors: True
      changed_when: false
      register: is_zoom

    - name : Install Zoom
      apt:
        deb: https://zoom.us/client/latest/zoom_amd64.deb
      become: yes
      when: is_zoom is failed

    - name: Check if Visual Studio Code is installed
      shell: dpkg-query -W 'code'
      ignore_errors: True
      changed_when: false
      register: is_code

    - name : Install Visual Studio Code
      apt:
        deb: https://go.microsoft.com/fwlink/?LinkID=760868
      become: yes
      when: is_code is failed

    - name: Check if Discord is installed
      shell: dpkg-query -W 'discord'
      ignore_errors: True
      changed_when: false
      register: is_discord

    - name : Install Discord
      apt:
        deb: https://discordapp.com/api/download?platform=linux&format=deb
      become: yes
      when: is_discord is failed

    - name: Check if Slack is installed
      shell: dpkg-query -W 'slack-desktop'
      ignore_errors: True
      changed_when: false
      register: is_slack

    - name : Install Slack
      apt:
        deb: https://downloads.slack-edge.com/linux_releases/slack-desktop-3.1.0-amd64.deb
      become: yes
      when: is_slack is failed

    - name: Check if Dropbox is installed
      shell: dpkg-query -W 'dropbox'
      ignore_errors: True
      changed_when: false
      register: is_dropbox

    - name : Install Dropbox
      apt:
        deb: https://www.dropbox.com/download?dl=packages/ubuntu/dropbox_2015.10.28_amd64.deb
      become: yes
      when: is_dropbox is failed

    - name: Remove useless packages from the cache
      apt:
        autoclean: yes
      become: yes

    - name: Remove dependencies that are no longer required
      apt:
        autoremove: yes
      become: yes

    # Set of symlinks required for VMWare Horizon Client
    - name: Symlinks required for VMWare Hortizon Client
      file:
        src: "/usr/lib/x86_64-linux-gnu/{{ item }}-1.0.so.0"
        dest: "/usr/lib/x86_64-linux-gnu/{{ item }}-0.10.so.0"
        owner: root
        group: root
        state: link
      with_items:
        - libgstreamer
        - libgstapp
        - libgstbase
      become: yes

    - name: Add setting to Terminator config
      lineinfile:
        path: ~/.config/terminator/config
        regexp: '.*size =.*'
        insertafter: '.*type = Window'
        line: '      size = 2000, 1000'
        create: no

    - name: Install pip packages
      pip:
        name: "{{ packages }}"
      vars:
        packages:
          - boardgamegeek2 # purely for my own enjoyment
          - mdv # View Markdown Files in Terminal
      become: yes

    # - name: Add an Apt signing key, uses whichever key is at the URL
    #   apt_key:
    #     url: "{{ item }}"
    #     state: present
    #   with_items:
    #     - https://www.virtualbox.org/download/oracle_vbox_2016.asc
    #     - https://www.virtualbox.org/download/oracle_vbox.asc

    # Set fs.inotify.max_user_watches required for larger VS code workspaces
    # Default: 8192
    # https://code.visualstudio.com/docs/setup/linux#_visual-studio-code-is-unable-to-watch-for-file-changes-in-this-large-workspace-error-enospc
    - name: Set fs.inotify.max_user_watches
      sysctl:
        name: fs.inotify.max_user_watches
        value: 524288
        sysctl_set: yes
        state: present
        reload: yes
      become: yes

    # - name: Add Docker Apt signing key
    #   apt_key:
    #     url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
    #     state: present
    #   become: yes

    # - name: Add Docker repo
    #   apt_repository:
    #     repo: "deb [arch=amd64] https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable"
    #     state: present
    #   become: yes

    # - name : Install Docker CE packages
    #   apt:
    #     name:
    #       - docker-ce
    #       - docker-ce-cli
    #       - containerd.io
    #   become: yes

    - name: Add Microsoft Signing Key
      apt_key:
        keyserver: packages.microsoft.com
        id: BC528686B50D79E339D3721CEB3E94ADBE1229CF
        keyring: /etc/apt/trusted.gpg.d/Microsoft.gpg
        state: present
      become: yes

    - name: Add Azure cli repo
      apt_repository:
        repo: "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ {{ ansible_distribution_release }} main"
        state: present
      become: yes

    - name : Install azure cli
      apt:
        name:
          - azure-cli
      become: yes

    # https://github.com/magicmonty/bash-git-prompt
    - name: Get git bash prompt
      git:
        repo: 'https://github.com/magicmonty/bash-git-prompt.git'
        dest: ~/.bash-git-prompt
        depth: 1
        update: no